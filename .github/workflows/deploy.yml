# Deploy Workflow
#
# Provisions CloudStack infrastructure and deploys with Kamal.
#
# Required GitHub Secrets:
#   CLOUDSTACK_API_KEY    - CloudStack API key
#   CLOUDSTACK_SECRET_KEY - CloudStack secret key
#   SSH_PRIVATE_KEY       - SSH private key for VM access
#   POSTGRES_USER         - PostgreSQL username (if db_enabled)
#   POSTGRES_PASSWORD     - PostgreSQL password (if db_enabled)
#
# Note: GITHUB_TOKEN is used for ghcr.io registry access (no separate REGISTRY_TOKEN needed).

name: Deploy

permissions:
  contents: read
  packages: write

on:
  workflow_dispatch:
    inputs:
      zone:
        description: "CloudStack zone"
        type: choice
        default: "ZP01"
        options:
          - ZP01
          - ZP02
      domain:
        description: "Domain (optional, for future use)"
        required: false
        default: ""
      web_plan:
        description: "Web VM plan"
        type: choice
        default: "small"
        options:
          - micro
          - small
          - medium
          - large
          - xlarge
          - 2xlarge
          - 4xlarge
      blob_disk_size_gb:
        description: "Web blob disk size in GB"
        required: false
        default: "20"
      workers_enabled:
        description: "Enable worker VMs"
        type: boolean
        default: false
      workers_replicas:
        description: "Number of worker replicas"
        required: false
        default: "1"
      workers_cmd:
        description: "Command for worker containers"
        required: false
        default: "sleep infinity"
      workers_plan:
        description: "Worker VM plan"
        type: choice
        default: "small"
        options:
          - micro
          - small
          - medium
          - large
          - xlarge
          - 2xlarge
          - 4xlarge
      db_enabled:
        description: "Enable database VM"
        type: boolean
        default: false
      db_plan:
        description: "Database VM plan"
        type: choice
        default: "medium"
        options:
          - micro
          - small
          - medium
          - large
          - xlarge
          - 2xlarge
          - 4xlarge
      db_disk_size_gb:
        description: "Database disk size in GB"
        required: false
        default: "20"

jobs:
  deploy:
    runs-on: ubuntu-latest
    outputs:
      web_ip: ${{ steps.outputs.outputs.web_ip }}
      worker_ips: ${{ steps.outputs.outputs.worker_ips }}
      db_ip: ${{ steps.outputs.outputs.db_ip }}
      db_internal_ip: ${{ steps.outputs.outputs.db_internal_ip }}

    steps:
      - name: Validate secrets
        if: inputs.db_enabled
        env:
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        run: |
          missing=()
          [ -z "$POSTGRES_USER" ] && missing+=("POSTGRES_USER")
          [ -z "$POSTGRES_PASSWORD" ] && missing+=("POSTGRES_PASSWORD")
          if [ ${#missing[@]} -gt 0 ]; then
            echo "::error::db_enabled is true but required secrets are missing: ${missing[*]}"
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build configuration
        env:
          INPUT_ZONE: ${{ inputs.zone }}
          INPUT_DOMAIN: ${{ inputs.domain }}
          INPUT_WEB_PLAN: ${{ inputs.web_plan }}
          INPUT_BLOB_DISK_SIZE_GB: ${{ inputs.blob_disk_size_gb }}
          INPUT_WORKERS_ENABLED: ${{ inputs.workers_enabled }}
          INPUT_WORKERS_REPLICAS: ${{ inputs.workers_replicas }}
          INPUT_WORKERS_PLAN: ${{ inputs.workers_plan }}
          INPUT_DB_ENABLED: ${{ inputs.db_enabled }}
          INPUT_DB_PLAN: ${{ inputs.db_plan }}
          INPUT_DB_DISK_SIZE_GB: ${{ inputs.db_disk_size_gb }}
        run: |
          python3 << 'PYEOF'
          import json, os
          config = {
              "zone": os.environ.get("INPUT_ZONE") or "ZP01",
              "domain": os.environ.get("INPUT_DOMAIN") or "",
              "web_plan": os.environ.get("INPUT_WEB_PLAN") or "small",
              "blob_disk_size_gb": int(os.environ.get("INPUT_BLOB_DISK_SIZE_GB") or "20"),
              "workers_enabled": os.environ.get("INPUT_WORKERS_ENABLED") == "true",
              "workers_replicas": int(os.environ.get("INPUT_WORKERS_REPLICAS") or "1"),
              "workers_plan": os.environ.get("INPUT_WORKERS_PLAN") or "small",
              "db_enabled": os.environ.get("INPUT_DB_ENABLED") == "true",
              "db_plan": os.environ.get("INPUT_DB_PLAN") or "medium",
              "db_disk_size_gb": int(os.environ.get("INPUT_DB_DISK_SIZE_GB") or "20"),
          }
          with open("/tmp/config.json", "w") as f:
              json.dump(config, f, indent=2)
          print("Configuration:")
          for k, v in config.items():
              print(f"  {k}: {v}")
          PYEOF

      - name: Extract SSH public key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          install -m 600 /dev/null /tmp/ssh_key
          printf '%s\n' "$SSH_PRIVATE_KEY" > /tmp/ssh_key
          ssh-keygen -y -f /tmp/ssh_key > /tmp/ssh_key.pub
          echo "Public key extracted successfully."

      - name: Install and configure CloudMonkey
        env:
          CLOUDSTACK_API_KEY: ${{ secrets.CLOUDSTACK_API_KEY }}
          CLOUDSTACK_SECRET_KEY: ${{ secrets.CLOUDSTACK_SECRET_KEY }}
        run: |
          wget -q https://github.com/apache/cloudstack-cloudmonkey/releases/latest/download/cmk.linux.x86-64
          chmod +x cmk.linux.x86-64
          sudo mv cmk.linux.x86-64 /usr/local/bin/cmk
          cmk set url "https://painel-cloud.locaweb.com.br/client/api"
          cmk set apikey "$CLOUDSTACK_API_KEY"
          cmk set secretkey "$CLOUDSTACK_SECRET_KEY"
          cmk set output json
          cmk sync
          echo "Verifying CloudStack connectivity..."
          cmk list zones filter=name
          echo "CloudMonkey configured successfully."

      - name: Provision infrastructure
        run: |
          python3 -u scripts/provision_infrastructure.py \
            --repo-name "${{ github.event.repository.name }}" \
            --unique-id "${{ github.repository_id }}" \
            --config /tmp/config.json \
            --public-key /tmp/ssh_key.pub \
            --output /tmp/provision-output.json

      - name: Set outputs
        id: outputs
        run: |
          python3 << 'PYEOF'
          import json, os
          d = json.load(open('/tmp/provision-output.json'))
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"web_ip={d.get('web_ip', '')}\n")
              f.write(f"worker_ips={json.dumps(d.get('worker_ips', []))}\n")
              f.write(f"db_ip={d.get('db_ip', '')}\n")
              f.write(f"db_internal_ip={d.get('db_internal_ip', '')}\n")
          PYEOF

      - name: Upload provisioning output
        uses: actions/upload-artifact@v4
        with:
          name: provision-output
          path: /tmp/provision-output.json
          retention-days: 90

      - name: Print summary
        run: |
          python3 << 'PYEOF' >> $GITHUB_STEP_SUMMARY
          import json
          d = json.load(open('/tmp/provision-output.json'))
          print('## Infrastructure Provisioning Complete')
          print('')
          print('| Resource | Public IP |')
          print('|----------|-----------|')
          print(f'| Web | {d.get("web_ip", "N/A")} |')
          for i, ip in enumerate(d.get("worker_ips", []), 1):
              print(f'| Worker {i} | {ip} |')
          if d.get("db_ip"):
              print(f'| Database | {d["db_ip"]} |')
          PYEOF

      - name: Install Kamal
        run: |
          sudo gem install kamal --no-document
          kamal version

      - name: Prepare SSH key for Kamal
        run: |
          mkdir -p .kamal
          cp /tmp/ssh_key .kamal/ssh_key
          chmod 600 .kamal/ssh_key

      - name: Create Kamal secrets file
        run: |
          cat > .kamal/secrets << 'EOF'
          KAMAL_REGISTRY_PASSWORD=$KAMAL_REGISTRY_PASSWORD
          POSTGRES_USER=$POSTGRES_USER
          POSTGRES_PASSWORD=$POSTGRES_PASSWORD
          EOF

      - name: Generate Kamal deploy config
        env:
          INPUT_WORKERS_ENABLED: ${{ inputs.workers_enabled }}
          INPUT_WORKERS_CMD: ${{ inputs.workers_cmd }}
          INPUT_DB_ENABLED: ${{ inputs.db_enabled }}
          REPO_NAME: ${{ github.event.repository.name }}
          REPO_FULL: ${{ github.repository }}
          REPO_OWNER: ${{ github.repository_owner }}
        run: |
          python3 << 'PYEOF'
          import json, os, yaml

          d = json.load(open('/tmp/provision-output.json'))

          workers_enabled = os.environ.get('INPUT_WORKERS_ENABLED') == 'true'
          workers_cmd = os.environ.get('INPUT_WORKERS_CMD', '')
          db_enabled = os.environ.get('INPUT_DB_ENABLED') == 'true'
          repo_name = os.environ['REPO_NAME']
          repo_full = os.environ['REPO_FULL']
          repo_owner = os.environ['REPO_OWNER']

          web_ip = d.get('web_ip', '')
          worker_ips = d.get('worker_ips', [])
          db_ip = d.get('db_ip', '')
          db_internal_ip = d.get('db_internal_ip', '')

          config = {
              'service': repo_name,
              'image': repo_full,
              'registry': {
                  'server': 'ghcr.io',
                  'username': repo_owner,
                  'password': ['KAMAL_REGISTRY_PASSWORD'],
              },
              'ssh': {
                  'user': 'root',
                  'keys': ['.kamal/ssh_key'],
              },
              'servers': {
                  'web': {
                      'hosts': [web_ip],
                  },
              },
              'proxy': {
                  'host': f'{web_ip}.nip.io',
                  'app_port': 80,
                  'forward_headers': True,
                  'ssl': False,
                  'healthcheck': {
                      'path': '/up',
                      'interval': 3,
                      'timeout': 5,
                  },
              },
              'env': {
                  'clear': {
                      'BLOB_STORAGE_PATH': '/data/blobs',
                  },
              },
              'volumes': [
                  '/data/blobs:/data/blobs',
              ],
              'builder': {
                  'arch': 'amd64',
              },
              'readiness_delay': 15,
              'deploy_timeout': 180,
              'drain_timeout': 30,
          }

          if workers_enabled and worker_ips:
              config['servers']['workers'] = {
                  'hosts': worker_ips,
                  'cmd': workers_cmd,
                  'proxy': False,
              }

          if db_enabled:
              if db_internal_ip:
                  config['env']['clear']['DB_HOST'] = db_internal_ip
              config['env']['clear']['DB_PORT'] = '5432'
              config['env']['clear']['DB_NAME'] = repo_name
              config['env']['secret'] = [
                  'DB_USERNAME:POSTGRES_USER',
                  'DB_PASSWORD:POSTGRES_PASSWORD',
              ]
              if db_ip:
                  config['accessories'] = {
                      'db': {
                          'image': 'postgres:16',
                          'host': db_ip,
                          'port': '5432:5432',
                          'cmd': '--shared_buffers=256MB',
                          'env': {
                              'clear': {
                                  'POSTGRES_DB': repo_name,
                              },
                              'secret': [
                                  'POSTGRES_USER',
                                  'POSTGRES_PASSWORD',
                              ],
                          },
                          'directories': [
                              '/data/db:/var/lib/postgresql/data',
                          ],
                      },
                  }

          os.makedirs('config', exist_ok=True)
          with open('config/deploy.yml', 'w') as f:
              yaml.dump(config, f, default_flow_style=False, sort_keys=False)

          print('Generated config/deploy.yml:')
          with open('config/deploy.yml') as f:
              print(f.read())
          PYEOF

      - name: Deploy with Kamal
        env:
          KAMAL_REGISTRY_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        run: kamal setup

      - name: Print Kamal deployment summary
        run: |
          python3 << 'PYEOF' >> $GITHUB_STEP_SUMMARY
          import json, os
          d = json.load(open('/tmp/provision-output.json'))
          web_ip = d.get('web_ip', 'N/A')
          sha = os.environ.get('GITHUB_SHA', 'unknown')[:7]
          repo = os.environ.get('GITHUB_REPOSITORY', '')
          print('')
          print('## Kamal Deployment Complete')
          print('')
          print(f'- **Commit:** `{sha}`')
          print(f'- **Image:** `ghcr.io/{repo}:{sha}`')
          print(f'- **URL:** http://{web_ip}')
          print(f'- **Health check:** http://{web_ip}/up')
          PYEOF
